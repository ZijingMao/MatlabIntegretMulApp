/*
 * Academic License - for use in teaching, academic research, and meeting
 * course requirements at degree granting institutions only.  Not for
 * government, commercial, or other organizational use.
 * File: pwelch_trans_v2.c
 *
 * MATLAB Coder version            : 3.0
 * C/C++ source code generated on  : 10-May-2016 22:57:56
 */

/* Include Files */
#include "rt_nonfinite.h"
#include "calc_bandpower.h"
#include "pwelch_trans_v2.h"
#include "compute_fft.h"
#include "compute_psd.h"
#include "rdivide.h"

/* Function Definitions */

/*
 * Arguments    : const double x[768]
 *                creal_T pxx[257]
 *                double f[257]
 * Return Type  : void
 */
void pwelch_trans_v2(const double x[768], creal_T pxx[257], double f[257])
{
  creal_T Sxx[512];
  int i;
  int i0;
  int i1;
  double x_data[768];
  int loop_ub;
  creal_T Sxxk[512];
  static const double dv0[256] = { 0.086956521739130377, 0.087095098010102012,
    0.087510742693911014, 0.0882032034543141, 0.0891720599011227,
    0.0904167238454206, 0.091936439656650715, 0.093730284721355639,
    0.095797170003292742, 0.098135840704583255, 0.10074487702749563,
    0.10362269503639898, 0.10676754761936391, 0.11017752554882765,
    0.11385055864067817, 0.11778441701105491, 0.12197671243010261,
    0.12642489977185606, 0.13112627855937592, 0.13607799460419767,
    0.14127704173909833, 0.14672026364312829, 0.15240435575780176,
    0.15832586729328052, 0.16448120332333549, 0.1708666269678118,
    0.17747826166127384, 0.18431209350645328, 0.19136397371106961,
    0.19862962110654631, 0.20610462474709035, 0.21378444658756091,
    0.22166442423849797, 0.22973977379664084, 0.23800559274921684,
    0.24645686295023728, 0.25508845366699406, 0.2638951246949075,
    0.27287152953883359, 0.28201221865889975, 0.29131164277889948,
    0.30076415625523556, 0.31036402050436851, 0.32010540748668703,
    0.32998240324468858, 0.33998901149331939, 0.3501191572602953,
    0.36036669057419357, 0.37072539019807571, 0.38118896740637642,
    0.39175106980276408, 0.40240528517665441, 0.41314514539603941,
    0.42396413033426411, 0.43485567182836959, 0.445813157666599,
    0.45682993560264462, 0.46789931739420143, 0.47901458286337123,
    0.49016898397645692, 0.50135574894066648, 0.5125680863152422,
    0.52379918913451717, 0.53504223904039716, 0.54629041042175885,
    0.55753687455825163, 0.5687748037659861, 0.579997375542595,
    0.59119777670914608, 0.602369207546397, 0.61350488592287811,
    0.62459805141229652, 0.63564196939776541, 0.64662993516036293,
    0.65755527794953994, 0.66841136503290732, 0.67919160572294035,
    0.68988945537815982, 0.70049841937635848, 0.711012057057459,
    0.72142398563361443, 0.73172788406417322, 0.74191749689315767,
    0.75198663804692711, 0.76192919458971775, 0.77173913043478248,
    0.78141049000887586, 0.79093740186785733, 0.80031408226122358,
    0.80953483864339959, 0.81859407312966048, 0.82748628589458584,
    0.83620607851098128, 0.84474815722724284, 0.85310733618117207,
    0.86127854054829256, 0.86925680962275642, 0.87703729982896861,
    0.88461528766210229, 0.891986172555721, 0.89914547967476266,
    0.9060888626321959, 0.91281210612769337, 0.91931112850672458,
    0.92558198423851157, 0.93162086631134544, 0.9374241085438082,
    0.94298818781049665, 0.94830972618089782, 0.95338549297011776,
    0.95821240670021735, 0.96278753697096486, 0.96710810623887089,
    0.97117149150342441, 0.97497522589950447, 0.9785170001950062,
    0.98179466419276507, 0.98480622803593332, 0.98754986341601525,
    0.99002390468282431, 0.99222684985569432, 0.994157361535325,
    0.99581426771571224, 0.99719656249566846, 0.99830340668950046,
    0.99913412833647663, 0.99968822310877137, 0.99996535461764013,
    0.99996535461764013, 0.99968822310877137, 0.99913412833647663,
    0.99830340668950046, 0.99719656249566846, 0.99581426771571224,
    0.994157361535325, 0.99222684985569432, 0.99002390468282431,
    0.98754986341601525, 0.98480622803593332, 0.981794664192765,
    0.9785170001950062, 0.97497522589950458, 0.97117149150342441,
    0.967108106238871, 0.96278753697096486, 0.95821240670021735,
    0.953385492970118, 0.94830972618089793, 0.94298818781049687,
    0.9374241085438082, 0.93162086631134555, 0.92558198423851157,
    0.91931112850672458, 0.91281210612769348, 0.90608886263219568,
    0.89914547967476255, 0.89198617255572088, 0.8846152876621024,
    0.87703729982896861, 0.86925680962275642, 0.86127854054829267,
    0.85310733618117207, 0.84474815722724306, 0.83620607851098172,
    0.82748628589458617, 0.81859407312966059, 0.80953483864339959,
    0.80031408226122358, 0.79093740186785744, 0.78141049000887586,
    0.77173913043478248, 0.76192919458971764, 0.75198663804692711,
    0.74191749689315778, 0.73172788406417322, 0.72142398563361443,
    0.711012057057459, 0.70049841937635848, 0.68988945537816,
    0.67919160572294035, 0.66841136503290755, 0.65755527794954027,
    0.64662993516036327, 0.63564196939776574, 0.62459805141229674,
    0.61350488592287833, 0.602369207546397, 0.59119777670914608,
    0.579997375542595, 0.56877480376598621, 0.55753687455825174,
    0.546290410421759, 0.53504223904039727, 0.5237991891345174,
    0.51256808631524242, 0.5013557489406667, 0.49016898397645708,
    0.47901458286337117, 0.46789931739420143, 0.45682993560264462,
    0.4458131576665989, 0.43485567182836965, 0.42396413033426417,
    0.41314514539603953, 0.40240528517665453, 0.39175106980276414,
    0.38118896740637664, 0.37072539019807588, 0.36036669057419379,
    0.35011915726029563, 0.33998901149331973, 0.32998240324468886,
    0.32010540748668731, 0.31036402050436851, 0.30076415625523567,
    0.29131164277889948, 0.2820122186588998, 0.2728715295388337,
    0.26389512469490733, 0.2550884536669939, 0.24645686295023705,
    0.23800559274921673, 0.22973977379664079, 0.22166442423849791,
    0.21378444658756113, 0.20610462474709057, 0.19862962110654653,
    0.19136397371106995, 0.18431209350645328, 0.1774782616612739,
    0.17086662696781185, 0.1644812033233356, 0.15832586729328063,
    0.15240435575780187, 0.14672026364312846, 0.14127704173909827,
    0.13607799460419762, 0.13112627855937586, 0.126424899771856,
    0.12197671243010266, 0.11778441701105491, 0.11385055864067817,
    0.1101775255488277, 0.10676754761936397, 0.10362269503639904,
    0.10074487702749568, 0.09813584070458331, 0.095797170003292742,
    0.0937302847213557, 0.09193643965665077, 0.090416723845420655,
    0.0891720599011227, 0.0882032034543141, 0.087510742693911014,
    0.087095098010102012, 0.086956521739130377 };

  creal_T b_Sxx[512];
  creal_T dcv0[512];

  /*  L = fix(M/4.5);  % the length of the window */
  /*  noverlap = fix(L/2); */
  /*  Compute the number of segments */
  memset(&Sxx[0], 0, sizeof(creal_T) << 9);
  for (i = 0; i < 3; i++) {
    if (1 + (i << 8) > 256 + (i << 8)) {
      i0 = 1;
      i1 = 0;
    } else {
      i0 = (i << 8) + 1;
      i1 = (i << 8) + 256;
    }

    loop_ub = (i1 - i0) + 1;
    for (i1 = 0; i1 < loop_ub; i1++) {
      x_data[i1] = x[(i0 + i1) - 1];
    }

    compute_fft(x_data, dv0, Sxxk);
    for (i0 = 0; i0 < 512; i0++) {
      Sxx[i0].re += Sxxk[i0].re;
      Sxx[i0].im += Sxxk[i0].im;
    }
  }

  memcpy(&b_Sxx[0], &Sxx[0], sizeof(creal_T) << 9);

  /*  Average the sum of the periodograms */
  for (i0 = 0; i0 < 257; i0++) {
    f[i0] = 0.5 * (double)i0;
  }

  rdivide(b_Sxx, 3.0, dcv0);
  compute_psd(dcv0, pxx);
}

/*
 * File trailer for pwelch_trans_v2.c
 *
 * [EOF]
 */
